---
title: "Chinook_salmon_analysis"
author: "Charles Hendrickson"
date: "12/2/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# Load all the packages needed here
library(tidyverse)
library(readr)
library(gt)
library(tufte)
library(feasts)
library(tsibble)
```


# I am interested in answering the following question, "Is the mean fork length (length of fish) of Chinook salmon different in sites with colder water temperatures than sites with warmer water temperatures?" There are 61 different sampling sites where the fork length and water temperature was taken from 1976-2021. My plan is to take the mean water temp across all sites and then compare the mean water temp of each individual site to this overall mean water temp, with sites being over this value having 'warmer than average water temps' and vice versa. I will conduct a hypothesis test, where the null is that there is no difference in fork length in warmer vs. colder water temps. I will complete a similar analysis to lab 7 from class. With regards to some of my 61 samples being warmer and colder, how should I approach comparing the two because we only worked with two different samples in class whereas I am working with 61. Let me know what you think! I am excited to see if this works out

- Project Question: "Is the mean fork length of Chinook salmon different at sites with colder water temperatures than in warmer water temperatures on average?"

- I will consider differences in the mean Chinook salmon fork length (mm) across sites with different mean water temperatures in the San Francisco Estuary (1976-2021), and conduct a simple hypothesis test.

- Load Data 
```{r}
# URL of data set: https://portal.edirepository.org/nis/metadataviewer?packageid=edi.244.8

# Import data and convert it to a data frame
DJFMP_df <- as.data.frame(
  read.csv(file = "data/1976-2021_DJFMP_beach_seine_fish_and_water_quality_data.csv"))

```

-Filter Data
```{r}
# Filter data set for just Chinook salmon (CHN) observations 
DJFMP_CHN_df <- DJFMP_df %>% 
  filter(OrganismCode == 'CHN') %>% 
  select(Location, SampleDate, ForkLength, WaterTemp) %>% 
  mutate(SampleDate = as.Date(SampleDate))

```

- Remove Outliers 
```{r}
# Check for outliers
large_outliers <- DJFMP_CHN_df %>% 
  filter(ForkLength > 250)

small_outliers <- DJFMP_CHN_df %>% 
  filter(ForkLength <= 0)

# Remove these because fish cannot cannot have a fork length of zero mm and we only want juvenile Chinook salmon that are below 250 mm in length, not adults.
DJFMP_CHN_df <- DJFMP_CHN_df %>% 
  filter(ForkLength != 0 & ForkLength < 250)
```
**All the Chinook salmon larger than 250mm are classified as `adults`. All Chinook salmon that are 0mm are Null**

- Plot Data
```{r}
# Plot Chinook salmon fork length over time
ggplot(data = DJFMP_CHN_df, aes(x = SampleDate, y = ForkLength)) +
  geom_line() +
  labs(title = "Fork Length of Chinook Salmon (1976-2021)",
       x = "Date",
       y = "Fork Length (mm)")
```

- Make a scatter plot showing changes in Chinook salmon fork length ($y$-axis) as it relates to water temperature ($x$-axis). 
```{r}
forklength_vs_watertemp <- ggplot(data = DJFMP_CHN_df, 
                                  aes(x = WaterTemp, 
                                      y = ForkLength)) +
  geom_point(size = 1) +
  labs(title = "Relationship Between Chinook Salmon Fork Length and Water Temp",
       x = "Water Temperature (degrees C) ",
       y = "Fork Length (mm)") +
  theme_bw()

forklength_vs_watertemp
```
- Make a density plot of Chinook salmon fork length ($y$-axis) as it relates to water temperature ($x$-axis). 
```{r}
# Determine where data density is relatively high versus low
forklength_vs_watertemp_alpha <- ggplot(data = DJFMP_CHN_df, 
                                        aes(x = WaterTemp, 
                                            y = ForkLength)) +
  geom_point(alpha=0.1, size=1) +
  labs(title = "Relationship Between Chinook Salmon Fork Length and Water Temp",
       x = "Water Temperature (degrees C) ",
       y = "Fork Length (mm)") +
  theme_bw() 

forklength_vs_watertemp_alpha
```

```{r}
# Make a density plot with `geom_bin2d()
forklength_vs_watertemp_density <- ggplot(data = DJFMP_CHN_df, 
                                  aes(x = WaterTemp, 
                                      y = ForkLength)) +
  geom_bin2d() +
  labs(title = "Relationship Between Chinook Salmon Fork Length and Water Temp",
       x = "Water Temperature (degrees C) ",
       y = "Fork Length (mm)") +
  theme_bw()

forklength_vs_watertemp_density
```

- Use the `lm()` command to estimate the following simple linear regression:
$$ \text{fork length}_i = \beta_0 + \beta_1 \text{water temperature}_i + \varepsilon_i $$
```{r}
# We can use lm(y~x, my_data) in R to run a linear regression of y on x, including a constant term.
summary(lm(ForkLength ~ WaterTemp, data = DJFMP_CHN_df))
```

**Intercept:** On average, the predicted fork length of a Chinook salmon for a zero degree Celsius change in water temperature is 30.3742 (mm).  

- **Coefficient on water temperature (WaterTemp):** On average, the predicted fork length of a Chinook salmon increases by 1.6276 (mm) for every one degree Celsius increase in water temperature. 


```{r}
forklength_vs_watertemp <- ggplot(data = DJFMP_CHN_df, 
                                  aes(x = WaterTemp, 
                                      y = ForkLength)) +
  geom_point() +
  geom_smooth(method = 'lm', formula= y~x, se=FALSE, size=1) +
  labs(title = "Relationship Between Chinook Salmon Fork Length and Water Temp",
       x = "Water Temperature (degrees C) ",
       y = "Fork Length (mm)") +
  theme_bw()

forklength_vs_watertemp
```

```{r}
library(modelr)

# regression
model_1 <- lm(ForkLength ~ WaterTemp, data = DJFMP_CHN_df)

# create predictions and residuals
predictions <- DJFMP_CHN_df %>% add_predictions(model_1) %>%
  mutate(residuals = ForkLength - pred)

# histogram
ggplot(data = predictions) + geom_histogram(aes(residuals), bins=25) +
  labs(title = "Residual Distribution") +
  theme_classic()
```

```{r}
# mean
mean(predictions$residuals)

# variance in residuals against fork length
ggplot(predictions) + geom_point(aes(x = ForkLength, y = residuals))
```


# -----------------------------------------------------------------------------
- Second analysis 


- Compute the mean and standard deviation of the fork length of Chinook salmon across the seine locations in the San Francisco Estuary.  
```{r}
# Drop NA's from WaterTemp column
DJFMP_CHN_df <- DJFMP_CHN_df[!is.na(DJFMP_CHN_df$WaterTemp),]

# Mean and SD of Chinook salmon length and water temp
summary_stats <- DJFMP_CHN_df %>%
  group_by(Location) %>% 
  summarise(sd_length = sd(ForkLength), mean_length = mean(ForkLength), 
            sd_water_temp = sd(WaterTemp),  mean_water_temp = mean(WaterTemp))

# Mean water temp over all sites 
mean_water_temp_overall <- mean(DJFMP_CHN_df$WaterTemp)

```

a. State your null and alternative hypotheses 
**Null Hypothesis**
$$H_{0}: \mu_{ForkLengthCold} - \mu_{ForkLengthWarm} = 0$$
**Alternative hypothesis**
$$H_{A}: \mu_{ForkLengthCold} - \mu_{ForkLengthWarm} \neq 0$$
b. Compute a point estimate of your parameter of interest
**point estimate**
```{r}
# First check which site has the max water temp and which has the min water temp. 
warm_temp_mean <- summary_stats %>%
  filter(mean_water_temp > mean_water_temp_overall) %>%
  summarise(warm_water_mean = mean(mean_water_temp))
  
cold_temp_mean <- summary_stats %>% 
  filter(mean_water_temp < mean_water_temp_overall) %>% 
  summarise(old_temp_mean = mean(mean_water_temp))

point_estimate <- as.numeric(warm_temp_mean - cold_temp_mean)
print(point_estimate)
```







```{r}
zero <- DJFMP_CHN_df %>% 
  filter(ForkLength = 0) %>% 
  summarise(ForkLength)
```








- Use the `lm()` command to estimate the following simple linear regression:
$$ \text{fork length}_i = \beta_0 + \beta_1 \text{water temperature}_i + \varepsilon_i $$
```{r}
# We can use lm(y~x, my_data) in R to run a linear regression of y on x, including a constant term.
summary(lm(ForkLength ~ WaterTemp, data = DJFMP_CHN_df))
```
**My regression results imply that we predict a gain of 0.0036 cm of equivalent water height per month in grid cells with zero irrigation. We also estimate that a one percentage point increase in a grid cell's irrigated area (e.g., from 43% irrigated to 44% irrigated, or from 86% irrigated to 87% irrigated) will lead to an increase in water loss of 0.0018 cm of equivalent water height per month. For example, consider a grid cell with 50% irrigated area and an existing downward trend in water storage of -0.001 cm of equivalent water height per month. If we increase irrigated area to 51%, we estimate the trend in water storage will change to: $-0.001 + -0.0018 = -0.0028$ cm e.w.h. per month.**






```{r}
# Find the mean of each month per site and then get the time series of that data frame. 

DJFMP_CHN_ts <- ts(DJFMP_CHN_df$ForkLength, start = c(1976, 05), frequency = 12)

# Load DJFMP_df data set 
DJFMP_tsbl <- tbl_df(DJFMP_df)

DJFMP_tsbl <- as.Date(DJFMP_tsbl$SampleDate)

mdeaths_tsbl <- as_tsibble(mdeaths)

# Create 
DJFMP_tsbl <- DJFMP_tsbl %>%
  as_tsibble(
    key = c(), 
    index = SampleDate, 
    regular = FALSE
  )

as.Date(DJFMP_tsbl$SampleDate)



decomp <- mdeaths_tsbl %>% 
  model(
    classical_decomposition(deaths, type = "additive")) %>%
  components() %>% 
  autoplot() +
  labs(title = "Classical additive decomposition of male deaths from lung disease (1974 - 1979)")

plot(decomp)
```


